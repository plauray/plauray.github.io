<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>THREE JS PROJECT</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<style>
		body {
			margin: 0;
		}
	</style>
</head>

<body>

	<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
	

	<script type="importmap">
  	{
    	"imports": {
     	 	"three": "https://unpkg.com/three@0.148.0/build/three.module.js",
      	"three/addons/": "https://unpkg.com/three@0.148.0/examples/jsm/"
    	}
  	}
	</script>

	<script type="module">
		import * as THREE from 'three';
		import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
		import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

		const radius = 3;

		const scene = new THREE.Scene();
		const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
		camera.position.set(2, 0, 5);

		const renderer = new THREE.WebGLRenderer();
		renderer.setSize(window.innerWidth, window.innerHeight);
		document.body.appendChild(renderer.domElement);

		const geometry = new THREE.BoxBufferGeometry();
		const material = new THREE.MeshPhongMaterial({ color: 0x00ff00 });



		const controls = new OrbitControls(camera, renderer.domElement);

		navigator.geolocation.getCurrentPosition(function (position) {
			let latitude = position.coords.latitude;
			let longitude = position.coords.longitude;
			let altitude = position.coords.altitude;

			let markerPos = convertCoords(latitude, longitude, altitude, radius);
			const loader = new GLTFLoader();
			loader.load('models/Soldier.glb', function (gltf) {
				var soldier = gltf.scene;
				soldier.scale.set(0.1, 0.1, 0.1);
				soldier.position.set(markerPos.x, markerPos.y, markerPos.z);
				scene.add(soldier);
			}, undefined, function (error) {
				console.error(error);
			});
		});

		//CREATION DE LA SPHERE AVEC LA TEXTURE TERRE
		const geometryEarth = new THREE.SphereGeometry(radius, 32, 32);
		const textureEarth = new THREE.TextureLoader().load('./textures/earthText.jpg');
		const materialEarth = new THREE.MeshBasicMaterial({ map: textureEarth });
		const earth = new THREE.Mesh(geometryEarth, materialEarth);
		earth.position.set(0, 0, 0);
		scene.add(earth);

		var light = new THREE.AmbientLight(0xffffff, 1);
		light.position.set(1, 1, 1).normalize();
		scene.add(light);

		var pays = new THREE.Group();
		$.get({
			url: 'https://restcountries.com/v3.1/all', success: function (data) {
				data.forEach((item, i) => {
					var posPays = convertCoords(item['latlng'][0], item['latlng'][1], 0, radius);
					const geometrySphere = new THREE.SphereGeometry(0.05, 32, 32);
					const textureSphere = new THREE.TextureLoader().load(item.flags.svg);
					const materialSphere = new THREE.MeshBasicMaterial({ map: textureSphere });
					var drapeaux = new THREE.Mesh(geometrySphere, materialSphere);

					drapeaux.position.x = posPays.x;
					drapeaux.position.y = posPays.y;
					drapeaux.position.z = posPays.z;

					pays.add(drapeaux);



				});
			}
		});

		scene.add(pays);

		const animate = function () {
			requestAnimationFrame(animate);
			renderer.render(scene, camera);
		};

		animate();

		if (window.DeviceOrientationEvent) {
			window.addEventListener('deviceorientation', function (orientation) {

			});
		}




		//FONCTIONS

		function convertCoords(lat, lon, alt, radius) {
			var phi = (lat) * Math.PI / 180;
			var theta = (lon - 180) * Math.PI / 180;

			var x = -(radius + alt) * Math.cos(phi) * Math.cos(theta);
			var y = (radius + alt) * Math.sin(phi);
			var z = (radius + alt) * Math.cos(phi) * Math.sin(theta);

			return new THREE.Vector3(x, y, z);
		}

	</script>
</body>

</html>